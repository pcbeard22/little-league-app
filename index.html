<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1b3a6b">
    <title>Yard Goats Baseball Field Manager</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="yardgoats-icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="yardgoats-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="yardgoats-icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Try to load from external file first (for local development)
        // If that fails, use the production config below
        var firebaseConfig = null;
    </script>
    <script src="firebase-config.js" onerror="// Using production config"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Mobile Field Collapse Styles */
        .field-toggle {
            display: none;
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .field-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .field-toggle {
                display: inline-block;
            }
            
            .field-section {
                transition: all 0.4s ease-in-out;
                overflow: visible;
                margin-bottom: 35px;
                padding-bottom: 20px;
                position: relative;
            }
            
            .field-section.collapsed {
                max-height: 80px;
            }
            
            .field-section.collapsed .canvas-container,
            .field-section.collapsed .inning-buttons {
                opacity: 0;
                pointer-events: none;
            }
            
            .field-section.collapsed .inning-selector label {
                display: none;
            }
            
            .field-section.collapsed .inning-buttons {
                display: none;
            }
            
            .field-section.collapsed .field-toggle {
                display: inline-block;
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
        }
        
        .header {
            background: linear-gradient(135deg, #1b3a6b 0%, #2d5a9b 50%, #4fb3b9 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
        }
        
        .header::before {
            content: '';
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: url('yardgoats-icon-192.png') no-repeat center;
            background-size: contain;
            opacity: 0.9;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        
        .header::after {
            content: '';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: url('yardgoats-icon-512.png') no-repeat center;
            background-size: contain;
            opacity: 0.9;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        
        .league-name {
            font-size: 1.2em;
            color: #ffd700;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .league-name {
                font-size: 0.9em;
                letter-spacing: 2px;
            }
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-family: 'Georgia', serif;
            font-style: italic;
            background: linear-gradient(45deg, #fff, #4fb3b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
        }
        
        .team-name {
            font-size: 1.6em;
            color: #4fb3b9;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .team-name {
                font-size: 1.2em;
            }
        }
        
        .game-controls {
            background: linear-gradient(to right, #f5f5f5, #e8f4f5);
            padding: 15px;
            border-bottom: 3px solid #1b3a6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .current-game-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .current-game-info label {
            color: #1b3a6b;
            font-weight: bold;
        }
        
        .game-name-input {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #1b3a6b;
            border-radius: 8px;
            width: 250px;
            background: white;
        }
        
        .game-name-input:focus {
            outline: none;
            border-color: #4fb3b9;
            box-shadow: 0 0 0 3px rgba(79, 179, 185, 0.2);
        }
        
        .game-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Mobile 2x2 Grid Layout for Buttons */
        @media (max-width: 768px) {
            .game-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 10px;
                width: 100%;
            }
            
            /* Reorder buttons for mobile */
            #loadGameBtn { order: 1; } /* My Games - top left */
            #newGameBtn { order: 2; } /* New Game - top right */
            #saveGameBtn { order: 3; } /* Save Lineup - bottom left */
            #shareGameBtn { order: 4; } /* Share - bottom right */
            
            .control-btn {
                width: 100%;
                padding: 12px 8px;
                font-size: 14px;
            }
        }
        
        .control-btn {
            padding: 8px 12px;
            background: white;
            color: #1b3a6b;
            border: 2px solid #1b3a6b;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #1b3a6b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 58, 107, 0.3);
        }
        
        .control-btn.primary {
            background: #2563eb;
            color: white;
            border: 2px solid #2563eb;
        }
        
        .control-btn.primary:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .control-btn.secondary {
            background: #6b7280;
            color: white;
            border: 2px solid #6b7280;
        }
        
        .control-btn.secondary:hover {
            background: #4b5563;
            border-color: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .control-btn.success {
            background: #10b981;
            color: white;
            border: 2px solid #10b981;
        }
        
        .control-btn.success:hover {
            background: #059669;
            border-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .control-btn.info {
            background: white;
            color: #1b3a6b;
            border: 2px solid #1b3a6b;
        }
        
        .control-btn.info:hover {
            background: #1b3a6b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 58, 107, 0.3);
        }
        
        /* Save status removed - auto-saving happens silently */
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(to bottom, #fff, #f8fcfc);
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 20px;
            }
            
            .header::before,
            .header::after {
                display: none;
            }
            
            .table-section {
                max-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 10px;
                gap: 10px;
            }
        }
        
        .field-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .inning-selector {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .inning-selector label {
            font-weight: 600;
            color: #1b3a6b;
            font-size: 1.1em;
        }
        
        .inning-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .inning-buttons {
                gap: 5px;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 3px 0;
            }
        }
        
        .inning-btn {
            padding: 15px 25px;
            font-size: 18px;
            border: 2px solid #1b3a6b;
            border-radius: 10px;
            background: white;
            color: #1b3a6b;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            min-width: 80px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .inning-btn {
                padding: 10px 15px;
                font-size: 16px;
                min-width: 65px;
                flex-shrink: 0;
            }
        }
        
        .inning-btn:hover {
            border-color: #4fb3b9;
            box-shadow: 0 4px 12px rgba(79, 179, 185, 0.3);
            transform: translateY(-2px);
        }
        
        .inning-btn:active {
            transform: translateY(0);
        }
        
        .inning-btn.active {
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            color: white;
            border-color: #1b3a6b;
            box-shadow: 0 4px 12px rgba(27, 58, 107, 0.3);
        }
        
        @media (max-width: 480px) {
            .inning-btn {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 70px;
            }
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
        }
        
        @media (max-width: 768px) {
            .canvas-container {
                max-width: 100%;
                padding: 0;
            }
        }
        
        #fieldCanvas {
            width: 100%;
            height: auto;
            border: 3px solid #1b3a6b;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(27, 58, 107, 0.2);
            background: white;
        }
        
        .table-section {
            overflow-x: auto;
            position: relative;
        }
        
        .table-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-section::-webkit-scrollbar-thumb {
            background: #1b3a6b;
            border-radius: 4px;
        }
        
        .table-section::-webkit-scrollbar-thumb:hover {
            background: #4fb3b9;
        }
        
        /* Mobile Card Layout for Players */
        .mobile-cards {
            display: none;
        }
        
        @media (max-width: 768px) {
            .table-section table {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
            
            .player-card {
                background: white;
                border: 2px solid #e0e0e0;
                border-radius: 12px;
                padding: 10px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: all 0.3s;
            }
            
            .player-card.dragging {
                opacity: 0.5;
                transform: scale(0.95);
            }
            
            .player-card:active {
                transform: scale(0.98);
            }
            
            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 2px solid #f0f0f0;
                gap: 8px;
            }
            
            .card-order {
                background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 18px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            }
            
            .card-name {
                flex: 1;
                margin: 0 15px;
            }
            
            .card-name input,
            .mobile-player-select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
            }
            
            .card-actions {
                display: flex;
                gap: 5px;
            }
            
            .card-actions button {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .card-move-up {
                background: #4fb3b9;
                color: white;
            }
            
            .card-move-down {
                background: #4fb3b9;
                color: white;
            }
            
            .card-delete {
                background: #d9534f;
                color: white;
            }
            
            .card-positions {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            
            .card-position {
                text-align: center;
            }
            
            .card-position label {
                display: block;
                font-size: 12px;
                color: #666;
                margin-bottom: 4px;
                font-weight: 600;
            }
            
            .card-position select {
                width: 100%;
                padding: 8px 4px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                text-align: center;
                background: white;
            }
            
            .drag-handle-card {
                cursor: move;
                color: #999;
                font-size: 24px;
                padding: 0 5px;
            }
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: linear-gradient(to bottom, #fff, #f8fcfc);
            z-index: 5;
            padding: 10px 0;
        }
        
        .table-header h2 {
            color: #1b3a6b;
            font-size: 1.5em;
            text-align: center;
            flex: 1;
        }
        
        .add-player-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(27, 58, 107, 0.3);
        }
        
        .add-player-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 179, 185, 0.4);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        th, td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #1b3a6b 0%, #2d5a9b 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        td {
            background: white;
        }
        
        .batting-order {
            font-weight: bold;
            color: #1b3a6b;
            font-size: 16px;
            width: 40px;
            text-shadow: 1px 1px 2px rgba(79, 179, 185, 0.3);
        }
        
        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-name-input {
            flex: 1;
            width: 100%;
            max-width: 140px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .player-name-input:focus {
            outline: none;
            border-color: #4fb3b9;
            box-shadow: 0 0 0 3px rgba(79, 179, 185, 0.2);
        }
        
        .position-select {
            width: 100%;
            min-width: 60px;
            padding: 6px 4px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .position-select:focus {
            outline: none;
            border-color: #4fb3b9;
            box-shadow: 0 0 0 3px rgba(79, 179, 185, 0.2);
            background: #f0fffe;
        }
        
        .position-select option[value="BN"] {
            background: #f5f5f5;
            color: #666;
        }
        
        .row-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
        
        .move-btn, .delete-btn {
            padding: 5px 8px;
            background: #1b3a6b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .move-btn:hover {
            background: #4fb3b9;
            transform: scale(1.1);
        }
        
        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .delete-btn {
            background: #d9534f;
        }
        
        .delete-btn:hover {
            background: #c9302c;
            transform: scale(1.1);
        }
        
        .drag-handle {
            cursor: move;
            color: #4fb3b9;
            font-size: 20px;
            padding: 0 10px;
            user-select: none;
        }
        
        .drag-handle:hover {
            color: #1b3a6b;
        }
        
        tr.dragging {
            opacity: 0.5;
            background: #f0f0f0;
        }
        
        tr.drag-over {
            background: #e6f9fa;
            border: 2px dashed #4fb3b9;
        }
        
        tr:hover td {
            background: #f8fcfc;
        }
        
        .info-box {
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid #ffd700;
            font-size: 13px;
        }
        
        .info-box p {
            margin: 5px 0;
        }
        
        .info-box strong {
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(27, 58, 107, 0.7);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
            border: 3px solid #1b3a6b;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1b3a6b 0%, #4fb3b9 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .close-modal {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            transform: scale(1.2);
            color: #ffd700;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .saved-games-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .saved-game-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            background: white;
        }
        
        .saved-game-item:hover {
            border-color: #4fb3b9;
            background: linear-gradient(to right, #ffffff, #f0fffe);
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(79, 179, 185, 0.2);
        }
        
        .saved-game-info h3 {
            margin: 0 0 5px 0;
            color: #1b3a6b;
        }
        
        .saved-game-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .saved-game-actions {
            display: flex;
            gap: 10px;
        }
        
        .load-btn, .delete-saved-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .load-btn {
            background: #1b3a6b;
            color: white;
        }
        
        .load-btn:hover {
            background: #4fb3b9;
            transform: scale(1.05);
        }
        
        .delete-saved-btn {
            background: #d9534f;
            color: white;
        }
        
        .delete-saved-btn:hover {
            background: #c9302c;
            transform: scale(1.05);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #1b3a6b;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #1b3a6b;
        }
        
        @media (max-width: 768px) {
            .game-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .current-game-info {
                flex-direction: column;
                align-items: stretch;
            }
            
            .game-name-input {
                width: 100%;
            }
            
            .game-buttons {
                justify-content: center;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
            
            .batting-order {
                font-size: 16px;
            }
            
            /* Full-screen modals on mobile */
            .modal-content {
                width: 100%;
                height: 100%;
                margin: 0;
                border-radius: 0;
                max-width: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .modal-header {
                border-radius: 0;
                padding: 15px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .modal-body {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 15px;
                max-height: none;
            }
            
            .saved-game-item {
                padding: 12px;
            }
            
            .saved-game-info h3 {
                font-size: 1.1em;
            }
            
            .saved-game-info p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="league-name">SMYRNA LITTLE LEAGUE</div>
            <h1>Yard Goats Field Manager</h1>
            <p>Manage your team roster, batting order, and save game configurations!</p>
        </div>
        
        <div class="game-controls">
            <div class="current-game-info">
                <label for="gameName">Game Name:</label>
                <input type="text" id="gameName" class="game-name-input" placeholder="Enter game name..." value="Yard Goats Game 1">
            </div>
            <div class="game-buttons">
                <button id="loadGameBtn" class="control-btn secondary">My Games</button>
                <button id="newGameBtn" class="control-btn success">New Game</button>
                <button id="saveGameBtn" class="control-btn primary">Save Lineup</button>
                <button id="shareGameBtn" class="control-btn info" style="display: inline-flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>Share</span>
                    <svg width="16" height="16" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                        <path d="M512,241.7L273.643,3.343v156.152c-71.41,3.744-138.015,33.337-188.958,84.28C30.075,298.384,0,370.991,0,448.222v60.436l29.069-52.985c45.354-82.671,132.173-134.027,226.573-134.027c5.986,0,12.004,0.212,18.001,0.632v157.779L512,241.7z M255.642,290.666c-84.543,0-163.661,36.792-217.939,98.885c26.634-114.177,129.256-199.483,251.429-199.483h15.489V78.131l163.568,163.568L304.621,405.267V294.531l-13.585-1.683C279.347,291.401,267.439,290.666,255.642,290.666z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="content">
            <div class="field-section" id="fieldSection">
                <div class="inning-selector">
                    <label>Select Inning:</label>
                    <div class="inning-buttons">
                        <button class="inning-btn active" data-inning="1">1st</button>
                        <button class="inning-btn" data-inning="2">2nd</button>
                        <button class="inning-btn" data-inning="3">3rd</button>
                        <button class="inning-btn" data-inning="4">4th</button>
                        <button class="inning-btn" data-inning="5">5th</button>
                    </div>
                </div>
                <div class="canvas-container">
                    <canvas id="fieldCanvas"></canvas>
                </div>
                <button class="field-toggle" id="fieldToggle">Collapse Field</button>
                <!-- <div class="info-box">
                    <p><strong>Position Abbreviations:</strong></p>
                    <p>P: Pitcher | C: Catcher | 1B/2B/3B: Bases | SS: Shortstop</p>
                    <p>LF/CF/RF: Outfield | BN: Bench</p>
                    <p><strong>Tip:</strong> Auto-save is enabled - changes save automatically!</p>
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 15px; align-items: center;">
                        <img src="yardgoats-icon-192.png" alt="Yard Goats Logo" style="width: 40px; height: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        <span style="color: #ffd700; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Yard Goats Baseball</span>
                    </div>
                </div> -->
            </div>
            
            <div class="table-section">
                <div class="table-header">
                    <h2>Player Positions & Batting Order</h2>
                    <button id="addPlayerBtn" class="add-player-btn">+ Add Player</button>
                </div>
                <table id="positionTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Order</th>
                            <th style="width: 140px; max-width: 140px;">Player Name</th>
                            <th style="width: 70px;">1st</th>
                            <th style="width: 70px;">2nd</th>
                            <th style="width: 70px;">3rd</th>
                            <th style="width: 70px;">4th</th>
                            <th style="width: 70px;">5th</th>
                            <th style="width: 90px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
                
                <!-- Mobile Card Layout -->
                <div id="mobileCards" class="mobile-cards">
                    <!-- Cards will be dynamically generated here -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="savedGamesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📂 Saved Games</h2>
                <button id="closeModalBtn" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="savedGamesList" class="saved-games-list">
                    </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        // For local development: uses firebase-config.js
        // For production: uses the config defined here
        
        // Production config (safe to commit since API key has domain restrictions)
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            firebaseConfig = {
                apiKey: "AIzaSyD8L0KG4UKPaJbInm5A4iO4VcH6ov02ejw",
                authDomain: "little-league-app-a9452.firebaseapp.com",
                projectId: "little-league-app-a9452",
                storageBucket: "little-league-app-a9452.firebasestorage.app",
                messagingSenderId: "268991389439",
                appId: "1:268991389439:web:d4acc88a14e30f596d36ca"
            };
        }
        
        // Initialize Firebase
        let db = null;
        let auth = null;
        let currentUser = null;
        
        // Only initialize if config is available
        if (firebaseConfig && firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Enable offline persistence (using new method to avoid deprecation warning)
            firebase.firestore().settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            // Sign in anonymously automatically
            auth.signInAnonymously().then(() => {
                console.log('Signed in anonymously');
            }).catch((error) => {
                console.error('Auth error:', error);
            });
            
            // Listen for auth changes
            auth.onAuthStateChanged((user) => {
                // Use a shared team ID instead of individual user IDs
                // This allows all devices to access the same games
                currentUser = {
                    uid: 'smyrna_yard_goats_team' // Shared team ID
                };
                if (user) {
                    console.log('Connected to team database');
                    updateSaveStatus('cloud');
                }
            });
        } else {
            console.log('Firebase not configured - using local storage only');
        }
        
        // Team roster - sorted alphabetically for easier selection
        const teamRoster = [
            "Aden Cobb",
            "Alex Carpenter",
            "Atlas Pietrusza",
            "Blake Thomas",
            "Cooper Corley",
            "Holden Lawder",
            "Hudson Beard",
            "Olyvar Williams",
            "Rodney Covington",
            "Ward Houvinen",
            "Zion Mattox"
        ];
        
        // Initial player data
        let playerData = [
            { name: "Atlas Pietrusza", positions: ["CF", "3B", "3B", "P", "BN"] },
            { name: "Holden Lawder", positions: ["C", "C", "BN", "1B", "BN"] },
            { name: "Rodney Covington", positions: ["SS", "P", "SS", "3B", "BN"] },
            { name: "Cooper Corley", positions: ["1B", "SS", "P", "SS", "BN"] },
            { name: "Alex Carpenter", positions: ["P", "1B", "CF", "CF", "BN"] },
            { name: "Zion Mattox", positions: ["2B", "LF", "1B", "2B", "BN"] },
            { name: "Hudson Beard", positions: ["3B", "CF", "2B", "RF", "BN"] },
            { name: "Olyvar Williams", positions: ["LF", "BN", "C", "C", "BN"] },
            { name: "Ward Houvinen", positions: ["RF", "2B", "LF", "BN", "BN"] },
            { name: "Aden Cobb", positions: ["BN", "RF", "RF", "LF", "BN"] },
            { name: "Blake Thomas", positions: ["BN", "BN", "BN", "BN", "BN"] }
        ];
        
        // Valid positions for dropdown
        const validPositions = [
            { value: "", label: "-- Select --" },
            { value: "P", label: "P - Pitcher" },
            { value: "C", label: "C - Catcher" },
            { value: "1B", label: "1B - First Base" },
            { value: "2B", label: "2B - Second Base" },
            { value: "3B", label: "3B - Third Base" },
            { value: "SS", label: "SS - Shortstop" },
            { value: "LF", label: "LF - Left Field" },
            { value: "CF", label: "CF - Center Field" },
            { value: "RF", label: "RF - Right Field" },
            { value: "BN", label: "BN - Bench" }
        ];
        
        // Position coordinates on the field
        const positionCoords = {
            'P': { x: 0.5, y: 0.6 },
            'C': { x: 0.5, y: 0.733 },
            '1B': { x: 0.7, y: 0.5 },
            '2B': { x: 0.617, y: 0.4 },
            '3B': { x: 0.3, y: 0.5 },
            'SS': { x: 0.383, y: 0.4 },
            'LF': { x: 0.2, y: 0.2 },
            'CF': { x: 0.5, y: 0.133 },
            'RF': { x: 0.8, y: 0.2 }
        };
        
        let draggedRow = null;
        let autoSaveTimeout = null;
        let canvasScale = 1;
        let currentInning = 1; // Track current inning
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Mobile Field Toggle
        const fieldSection = document.getElementById('fieldSection');
        const fieldToggle = document.getElementById('fieldToggle');
        
        if (fieldToggle) {
            fieldToggle.addEventListener('click', () => {
                fieldSection.classList.toggle('collapsed');
                fieldToggle.textContent = fieldSection.classList.contains('collapsed') ? 'Expand Field' : 'Collapse Field';
                
                // Smooth scroll to table when field is collapsed
                if (fieldSection.classList.contains('collapsed') && window.innerWidth <= 768) {
                    setTimeout(() => {
                        document.querySelector('.table-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                }
            });
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            loadFromUrl(); // Check for shared game in URL first
            loadFromLocalStorage();
            createTable();
            setupCanvas();
            updateField();
        });
        
        // Setup all event listeners
        function initializeEventListeners() {
            // Game controls
            document.getElementById('saveGameBtn').addEventListener('click', saveGame);
            document.getElementById('loadGameBtn').addEventListener('click', showSavedGames);
            document.getElementById('shareGameBtn').addEventListener('click', shareGame);
            document.getElementById('newGameBtn').addEventListener('click', newGame);
            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('closeModalBtn').addEventListener('click', closeSavedGames);
            
            // Inning buttons
            const inningButtons = document.querySelectorAll('.inning-btn');
            inningButtons.forEach(button => {
                button.addEventListener('click', handleInningChange);
            });
            
            // Game name input with auto-save
            document.getElementById('gameName').addEventListener('input', triggerAutoSave);
            
            // Modal close on outside click
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('savedGamesModal');
                if (event.target === modal) {
                    closeSavedGames();
                }
            });
            
            // Window resize for responsive canvas
            window.addEventListener('resize', () => {
                setupCanvas();
                updateField();
            });
            
            // Touch gestures for inning navigation
            setupTouchGestures();
        }
        
        // Setup touch gestures for swipe navigation
        function setupTouchGestures() {
            const fieldSection = document.querySelector('.field-section');
            
            fieldSection.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            fieldSection.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                handleSwipe(touchStartX, touchEndX, touchStartY, touchEndY);
            }, { passive: true });
        }
        
        // Handle swipe gestures
        function handleSwipe(startX, endX, startY, endY) {
            const diffX = endX - startX;
            const diffY = endY - startY;
            const threshold = 50; // Minimum distance for swipe
            
            // Only handle horizontal swipes
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
                if (diffX > 0) {
                    // Swipe right - previous inning
                    navigateInning(-1);
                } else {
                    // Swipe left - next inning
                    navigateInning(1);
                }
            }
        }
        
        // Navigate between innings
        function navigateInning(direction) {
            const newInning = currentInning + direction;
            if (newInning >= 1 && newInning <= 5) {
                // Update current inning
                currentInning = newInning;
                
                // Update button states
                document.querySelectorAll('.inning-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.dataset.inning) === currentInning) {
                        btn.classList.add('active');
                    }
                });
                
                // Update field display
                updateField();
            }
        }
        
        // Handle inning button clicks
        function handleInningChange(e) {
            // Remove active class from all buttons
            document.querySelectorAll('.inning-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            e.target.classList.add('active');
            
            // Update current inning
            currentInning = parseInt(e.target.dataset.inning);
            
            // Update the field display
            updateField();
        }
        
        // Setup responsive canvas
        function setupCanvas() {
            const canvas = document.getElementById('fieldCanvas');
            const container = document.querySelector('.canvas-container');
            const containerWidth = container.offsetWidth;
            
            // Set canvas actual size (for drawing) with device pixel ratio for crisp display
            const dpr = window.devicePixelRatio || 1;
            // Use full container width on mobile, max 450px on desktop
            const isMobile = window.innerWidth <= 768;
            const size = isMobile ? Math.min(containerWidth, window.innerWidth - 30) : Math.min(containerWidth, 450);
            
            // Set actual size in memory
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            
            // Set display size (CSS pixels)
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            
            // Scale context to ensure correct drawing operations
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            // Calculate scale for drawing
            canvasScale = size / 450;
        }
        
        // Auto-save functionality
        function triggerAutoSave() {
            // Clear existing timeout
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            // Update status to "saving"
            updateSaveStatus('saving');
            
            // Set new timeout for auto-save
            autoSaveTimeout = setTimeout(() => {
                autoSaveGame();
            }, 1000); // Save 1 second after user stops typing
        }
        
        function autoSaveGame() {
            const gameName = document.getElementById('gameName').value || 'Unnamed Game';
            const gameData = {
                name: gameName,
                players: playerData,
                savedAt: new Date().toISOString()
            };
            
            // Save to localStorage with a special key for current game
            try {
                localStorage.setItem('currentGame', JSON.stringify(gameData));
                updateSaveStatus('saved');
            } catch(e) {
                console.error('Unable to auto-save:', e);
                updateSaveStatus('error');
            }
        }
        
        // Manual save game function
        async function saveGame() {
            const gameName = document.getElementById('gameName').value || 'Unnamed Game';
            
            // Check if game name is empty
            if (!gameName || gameName === 'Unnamed Game') {
                alert('Please enter a game name before saving.');
                document.getElementById('gameName').focus();
                return;
            }
            
            const gameData = {
                name: gameName,
                players: playerData,
                savedAt: new Date().toISOString(),
                userId: 'smyrna_yard_goats_team' // Always use team ID
            };
            
            updateSaveStatus('saving');
            
            // Save to Firebase if available
            if (db && currentUser) {
                try {
                    // Generate a game ID
                    const gameId = gameName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                    
                    // Save to Firestore
                    await db.collection('games').doc(`${currentUser.uid}_${gameId}`).set(gameData);
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('currentGame', JSON.stringify(gameData));
                    
                    updateSaveStatus('saved');
                    alert(`Game "${gameName}" saved to cloud!`);
                } catch(error) {
                    console.error('Firebase save error:', error);
                    saveToLocalStorage(gameData);
                }
            } else {
                // Fallback to localStorage
                saveToLocalStorage(gameData);
            }
        }
        
        // Helper function for local storage saving
        function saveToLocalStorage(gameData) {
            let savedGames = [];
            try {
                savedGames = JSON.parse(localStorage.getItem('baseballGames') || '[]');
            } catch(e) {
                savedGames = [];
            }
            
            const existingIndex = savedGames.findIndex(game => game.name === gameData.name);
            
            if (existingIndex !== -1) {
                if (confirm(`Game "${gameData.name}" already exists locally. Overwrite?`)) {
                    savedGames[existingIndex] = gameData;
                } else {
                    return;
                }
            } else {
                savedGames.push(gameData);
            }
            
            try {
                localStorage.setItem('baseballGames', JSON.stringify(savedGames));
                localStorage.setItem('currentGame', JSON.stringify(gameData));
                updateSaveStatus('saved');
                alert(`Game "${gameData.name}" saved locally!`);
            } catch(e) {
                console.error('Unable to save game:', e);
                alert('Failed to save game. Please try again.');
                updateSaveStatus('error');
            }
        }
        
        function updateSaveStatus(status) {
            // Status updates now happen silently in the background
            // No visual indicator needed - auto-save happens automatically
            if (status === 'error') {
                console.error('Save error occurred');
            }
        }
        
        // Export game to JSON file
        function exportGame() {
            const gameName = document.getElementById('gameName').value || 'Unnamed Game';
            const gameData = {
                name: gameName,
                players: playerData,
                exportedAt: new Date().toISOString(),
                version: '1.0.0'
            };
            
            // Create blob and download link
            const dataStr = JSON.stringify(gameData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create download link and click it
            const a = document.createElement('a');
            a.href = url;
            a.download = `${gameName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateSaveStatus('saved');
            alert(`Game exported as ${a.download}`);
        }
        
        // Import game from JSON file
        function importGame(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const gameData = JSON.parse(e.target.result);
                    
                    // Validate the data
                    if (!gameData.players || !Array.isArray(gameData.players)) {
                        throw new Error('Invalid game file format');
                    }
                    
                    // Load the game data
                    playerData = gameData.players;
                    document.getElementById('gameName').value = gameData.name || 'Imported Game';
                    
                    // Recreate the table and field
                    createTable();
                    updateField();
                    
                    updateSaveStatus('saved');
                    alert(`Game "${gameData.name}" imported successfully!`);
                    
                    // Clear the file input
                    event.target.value = '';
                } catch(error) {
                    alert('Failed to import game. Please check the file format.');
                    console.error('Import error:', error);
                    event.target.value = '';
                }
            };
            
            reader.readAsText(file);
        }
        
        // Generate shareable link with multiple sharing options
        function shareGame() {
            const gameName = document.getElementById('gameName').value || 'Unnamed Game';
            const gameData = {
                n: gameName,  // Shortened keys for URL
                p: playerData,
                v: '1'
            };
            
            // Compress the data
            const jsonStr = JSON.stringify(gameData);
            const compressed = btoa(encodeURIComponent(jsonStr));
            
            // Create the shareable URL
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?game=${compressed}`;
            
            // Check if URL is too long
            if (shareUrl.length > 2000) {
                alert('Game data is too large to share via link. Please save to cloud instead.');
                return;
            }
            
            // Prepare share text
            const shareTitle = `${gameName} - Little League Lineup`;
            const shareText = `Check out my Little League lineup for ${gameName}!\n\n`;
            
            // Check if Web Share API is available (mobile devices)
            if (navigator.share) {
                navigator.share({
                    title: shareTitle,
                    text: shareText,
                    url: shareUrl
                })
                .then(() => {
                    console.log('Successfully shared');
                })
                .catch((error) => {
                    // User cancelled or error occurred
                    if (error.name !== 'AbortError') {
                        showShareOptions(shareUrl, shareTitle, shareText);
                    }
                });
            } else {
                // Desktop or no Web Share API - show custom share options
                showShareOptions(shareUrl, shareTitle, shareText);
            }
        }
        
        // Show custom share options (email, text, copy)
        function showShareOptions(shareUrl, shareTitle, shareText) {
            // Create modal for share options
            const modal = document.createElement('div');
            modal.className = 'share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <h3>Share Lineup</h3>
                    <div class="share-options">
                        <button onclick="shareViaEmail('${encodeURIComponent(shareTitle)}', '${encodeURIComponent(shareText + shareUrl)}')" class="share-option-btn">
                            <span>Email</span>
                        </button>
                        <button onclick="shareViaSMS('${encodeURIComponent(shareText + shareUrl)}')" class="share-option-btn">
                            <span>Text Message</span>
                        </button>
                        <button onclick="copyShareLink('${shareUrl}')" class="share-option-btn">
                            <span>Copy Link</span>
                        </button>
                    </div>
                    <button onclick="closeShareModal()" class="close-share-btn">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add styles for modal
            const style = document.createElement('style');
            style.textContent = `
                .share-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                }
                .share-modal-content {
                    background: white;
                    border-radius: 15px;
                    padding: 25px;
                    max-width: 400px;
                    width: 90%;
                }
                .share-modal-content h3 {
                    margin-bottom: 20px;
                    color: #1b3a6b;
                }
                .share-options {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    margin-bottom: 20px;
                }
                .share-option-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 15px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 16px;
                    font-weight: 500;
                }
                .share-option-btn:hover {
                    border-color: #4fb3b9;
                    background: #f0f8ff;
                }
                .close-share-btn {
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #f0f0f0;
                    cursor: pointer;
                    font-size: 16px;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Share via Email
        function shareViaEmail(subject, body) {
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            closeShareModal();
        }
        
        // Share via SMS
        function shareViaSMS(text) {
            // Check if on iOS or Android for proper SMS link
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const smsLink = isIOS ? `sms:&body=${text}` : `sms:?body=${text}`;
            window.location.href = smsLink;
            closeShareModal();
        }
        
        // Copy link to clipboard
        function copyShareLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
                closeShareModal();
            }).catch(() => {
                prompt('Copy this link:', url);
                closeShareModal();
            });
        }
        
        // Close share modal
        function closeShareModal() {
            const modal = document.querySelector('.share-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Load game from URL parameters
        function loadFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameData = urlParams.get('game');
            
            if (gameData) {
                try {
                    const decoded = decodeURIComponent(atob(gameData));
                    const game = JSON.parse(decoded);
                    
                    if (game.p && Array.isArray(game.p)) {
                        playerData = game.p;
                        document.getElementById('gameName').value = game.n || 'Shared Game';
                        createTable();
                        updateField();
                        
                        // Clear URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        alert(`Loaded shared game: ${game.n}`);
                    }
                } catch(error) {
                    console.error('Failed to load shared game:', error);
                }
            }
        }
        
        // Load from localStorage on startup
        function loadFromLocalStorage() {
            try {
                const currentGame = localStorage.getItem('currentGame');
                if (currentGame) {
                    const gameData = JSON.parse(currentGame);
                    playerData = gameData.players;
                    document.getElementById('gameName').value = gameData.name;
                }
            } catch(e) {
                console.error('Unable to load saved game:', e);
            }
        }
        
        // Game Management Functions
        async function showSavedGames() {
            const modal = document.getElementById('savedGamesModal');
            const savedGamesList = document.getElementById('savedGamesList');
            let savedGames = [];
            
            savedGamesList.innerHTML = '<div class="empty-state"><p>Loading games...</p></div>';
            modal.style.display = 'block';
            
            // Try to load from Firebase first
            if (db) {
                try {
                    const snapshot = await db.collection('games')
                        .where('userId', '==', 'smyrna_yard_goats_team')
                        .orderBy('savedAt', 'desc')
                        .get();
                    
                    savedGames = [];
                    snapshot.forEach(doc => {
                        savedGames.push({ id: doc.id, ...doc.data() });
                    });
                } catch(error) {
                    console.error('Firebase load error:', error);
                    // Fall back to localStorage
                    try {
                        savedGames = JSON.parse(localStorage.getItem('baseballGames') || '[]');
                    } catch(e) {
                        savedGames = [];
                    }
                }
            } else {
                // Use localStorage if Firebase not available
                try {
                    savedGames = JSON.parse(localStorage.getItem('baseballGames') || '[]');
                } catch(e) {
                    savedGames = [];
                }
            }
            
            savedGamesList.innerHTML = '';
            
            if (savedGames.length === 0) {
                savedGamesList.innerHTML = `
                    <div class="empty-state">
                        <h3>No Saved Games</h3>
                        <p>${db ? 'Save your first game to the cloud!' : 'Games are automatically saved locally!'}</p>
                    </div>
                `;
            } else {
                savedGames.forEach((game, index) => {
                    const gameItem = document.createElement('div');
                    gameItem.className = 'saved-game-item';
                    
                    const savedDate = new Date(game.savedAt);
                    const dateStr = savedDate.toLocaleDateString() + ' ' + savedDate.toLocaleTimeString();
                    
                    gameItem.innerHTML = `
                        <div class="saved-game-info">
                            <h3>${game.name}</h3>
                            <p>${game.players.length} players • Saved: ${dateStr}</p>
                        </div>
                        <div class="saved-game-actions">
                            <button class="load-btn" data-index="${index}">Load</button>
                            <button class="delete-saved-btn" data-index="${index}">Delete</button>
                        </div>
                    `;
                    
                    // Add event listeners to buttons
                    gameItem.querySelector('.load-btn').addEventListener('click', (e) => {
                        loadGame(parseInt(e.target.dataset.index));
                    });
                    
                    gameItem.querySelector('.delete-saved-btn').addEventListener('click', (e) => {
                        deleteSavedGame(parseInt(e.target.dataset.index));
                    });
                    
                    savedGamesList.appendChild(gameItem);
                });
            }
            
            // Also add current game to saved games if it exists
            const currentGame = localStorage.getItem('currentGame');
            if (currentGame) {
                const current = JSON.parse(currentGame);
                // Check if it's not already in saved games
                const exists = savedGames.some(game => game.name === current.name);
                if (!exists) {
                    savedGames.push(current);
                    localStorage.setItem('baseballGames', JSON.stringify(savedGames));
                }
            }
            
            modal.style.display = 'block';
        }
        
        function closeSavedGames() {
            document.getElementById('savedGamesModal').style.display = 'none';
        }
        
        function loadGame(index) {
            let savedGames = [];
            try {
                savedGames = JSON.parse(localStorage.getItem('baseballGames') || '[]');
            } catch(e) {
                savedGames = [];
            }
            
            if (savedGames[index]) {
                const game = savedGames[index];
                playerData = JSON.parse(JSON.stringify(game.players)); // Deep copy
                document.getElementById('gameName').value = game.name;
                createTable();
                updateField();
                closeSavedGames();
                
                // Save as current game
                autoSaveGame();
            }
        }
        
        function deleteSavedGame(index) {
            let savedGames = [];
            try {
                savedGames = JSON.parse(localStorage.getItem('baseballGames') || '[]');
            } catch(e) {
                savedGames = [];
            }
            
            const gameName = savedGames[index].name;
            
            if (confirm(`Are you sure you want to delete "${gameName}"?`)) {
                savedGames.splice(index, 1);
                localStorage.setItem('baseballGames', JSON.stringify(savedGames));
                showSavedGames(); // Refresh the list
            }
        }
        
        function newGame() {
            if (confirm('Start a new game? Any unsaved changes will be lost.')) {
                playerData = [
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] },
                    { name: "", positions: ["BN", "BN", "BN", "BN", "BN"] }
                ];
                document.getElementById('gameName').value = 'Yard Goats - New Game';
                createTable();
                updateField();
                autoSaveGame();
            }
        }
        
        function createTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Also create mobile cards
            createMobileCards();
            
            playerData.forEach((player, index) => {
                const row = document.createElement('tr');
                row.draggable = true;
                row.dataset.index = index;
                
                // Drag events
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                
                // Batting order cell
                const orderCell = document.createElement('td');
                orderCell.className = 'batting-order';
                orderCell.textContent = index + 1;
                row.appendChild(orderCell);
                
                // Player name cell with dropdown
                const nameCell = document.createElement('td');
                const nameDiv = document.createElement('div');
                nameDiv.className = 'player-name-cell';
                const nameSelect = document.createElement('select');
                nameSelect.className = 'player-name-input';
                
                // Add empty option first
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select Player --';
                nameSelect.appendChild(emptyOption);
                
                // Add all roster players
                teamRoster.forEach(playerName => {
                    const option = document.createElement('option');
                    option.value = playerName;
                    option.textContent = playerName;
                    if (player.name === playerName) {
                        option.selected = true;
                    }
                    nameSelect.appendChild(option);
                });
                
                // Add custom option
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = '+ Add Custom Player';
                nameSelect.appendChild(customOption);
                
                nameSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        const customName = prompt('Enter player name:');
                        if (customName && customName.trim()) {
                            playerData[index].name = customName.trim();
                            // Recreate the table to show the custom name
                            createTable();
                        } else {
                            // Reset to previous value if cancelled
                            e.target.value = player.name || '';
                        }
                    } else {
                        playerData[index].name = e.target.value;
                    }
                    updateField();
                    triggerAutoSave();
                });
                
                nameDiv.appendChild(nameSelect);
                nameCell.appendChild(nameDiv);
                row.appendChild(nameCell);
                
                // Position cells with dropdowns
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    const select = document.createElement('select');
                    select.className = 'position-select';
                    
                    // Create options
                    validPositions.forEach(pos => {
                        const option = document.createElement('option');
                        option.value = pos.value;
                        option.textContent = pos.value || '--';
                        if (pos.value === player.positions[i]) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    select.addEventListener('change', (e) => {
                        playerData[index].positions[i] = e.target.value;
                        updateField();
                        triggerAutoSave();
                    });
                    
                    cell.appendChild(select);
                    row.appendChild(cell);
                }
                
                // Action buttons cell
                const actionCell = document.createElement('td');
                const controlDiv = document.createElement('div');
                controlDiv.className = 'row-controls';
                
                const upBtn = document.createElement('button');
                upBtn.className = 'move-btn';
                upBtn.innerHTML = '↑';
                upBtn.title = 'Move up in batting order';
                upBtn.disabled = index === 0;
                upBtn.addEventListener('click', () => movePlayer(index, -1));
                
                const downBtn = document.createElement('button');
                downBtn.className = 'move-btn';
                downBtn.innerHTML = '↓';
                downBtn.title = 'Move down in batting order';
                downBtn.disabled = index === playerData.length - 1;
                downBtn.addEventListener('click', () => movePlayer(index, 1));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Remove player';
                deleteBtn.addEventListener('click', () => removePlayer(index));
                
                controlDiv.appendChild(upBtn);
                controlDiv.appendChild(downBtn);
                controlDiv.appendChild(deleteBtn);
                actionCell.appendChild(controlDiv);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Drag and drop handlers
        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove all drag-over classes
            const rows = document.querySelectorAll('tr');
            rows.forEach(row => row.classList.remove('drag-over'));
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedRow && this.parentNode.tagName === 'TBODY') {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedRow !== this && this.parentNode.tagName === 'TBODY') {
                const fromIndex = parseInt(draggedRow.dataset.index);
                const toIndex = parseInt(this.dataset.index);
                
                // Reorder the data
                const movedPlayer = playerData.splice(fromIndex, 1)[0];
                playerData.splice(toIndex, 0, movedPlayer);
                
                // Recreate the table and trigger auto-save
                createTable();
                updateField();
                triggerAutoSave();
            }
            
            return false;
        }
        
        function movePlayer(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < playerData.length) {
                // Swap players
                const temp = playerData[index];
                playerData[index] = playerData[newIndex];
                playerData[newIndex] = temp;
                
                createTable();
                updateField();
                triggerAutoSave();
            }
        }
        
        function removePlayer(index) {
            if (confirm(`Remove ${playerData[index].name || 'this player'} from the roster?`)) {
                playerData.splice(index, 1);
                createTable();
                updateField();
                triggerAutoSave();
            }
        }
        
        function addPlayer() {
            playerData.push({
                name: "New Player",
                positions: ["BN", "BN", "BN", "BN", "BN"]
            });
            createTable();
            
            // Focus on the new player's name input
            const inputs = document.querySelectorAll('.player-name-input');
            if (inputs.length > 0) {
                inputs[inputs.length - 1].focus();
                inputs[inputs.length - 1].select();
            }
            
            triggerAutoSave();
        }
        
        // Create mobile-friendly card layout
        function createMobileCards() {
            const container = document.getElementById('mobileCards');
            container.innerHTML = '';
            
            playerData.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.index = index;
                
                // Card HTML structure
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-order">${index + 1}</div>
                        <div class="card-name">
                            <select data-index="${index}" class="mobile-player-select">
                                <option value="">-- Select Player --</option>
                                ${teamRoster.map(playerName => 
                                    `<option value="${playerName}" ${player.name === playerName ? 'selected' : ''}>
                                        ${playerName}
                                    </option>`
                                ).join('')}
                                <option value="custom">+ Add Custom Player</option>
                            </select>
                        </div>
                        <div class="card-actions">
                            <button class="card-move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="card-move-down" data-index="${index}" ${index === playerData.length - 1 ? 'disabled' : ''}>↓</button>
                            <button class="card-delete" data-index="${index}">×</button>
                        </div>
                    </div>
                    <div class="card-positions">
                        <div class="card-position">
                            <label>1st</label>
                            <select data-index="${index}" data-inning="0">
                                ${validPositions.map(pos => 
                                    `<option value="${pos.value}" ${pos.value === player.positions[0] ? 'selected' : ''}>
                                        ${pos.value || '--'}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-position">
                            <label>2nd</label>
                            <select data-index="${index}" data-inning="1">
                                ${validPositions.map(pos => 
                                    `<option value="${pos.value}" ${pos.value === player.positions[1] ? 'selected' : ''}>
                                        ${pos.value || '--'}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-position">
                            <label>3rd</label>
                            <select data-index="${index}" data-inning="2">
                                ${validPositions.map(pos => 
                                    `<option value="${pos.value}" ${pos.value === player.positions[2] ? 'selected' : ''}>
                                        ${pos.value || '--'}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-position">
                            <label>4th</label>
                            <select data-index="${index}" data-inning="3">
                                ${validPositions.map(pos => 
                                    `<option value="${pos.value}" ${pos.value === player.positions[3] ? 'selected' : ''}>
                                        ${pos.value || '--'}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-position">
                            <label>5th</label>
                            <select data-index="${index}" data-inning="4">
                                ${validPositions.map(pos => 
                                    `<option value="${pos.value}" ${pos.value === player.positions[4] ? 'selected' : ''}>
                                        ${pos.value || '--'}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                const nameSelect = card.querySelector('.mobile-player-select');
                nameSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        const customName = prompt('Enter player name:');
                        if (customName && customName.trim()) {
                            playerData[index].name = customName.trim();
                            createMobileCards(); // Recreate to show custom name
                        } else {
                            // Reset to previous value if cancelled
                            e.target.value = playerData[index].name || '';
                        }
                    } else {
                        playerData[index].name = e.target.value;
                    }
                    updateField();
                    triggerAutoSave();
                });
                
                // Position selects
                card.querySelectorAll('.card-position select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const playerIndex = parseInt(e.target.dataset.index);
                        const inningIndex = parseInt(e.target.dataset.inning);
                        playerData[playerIndex].positions[inningIndex] = e.target.value;
                        updateField();
                        triggerAutoSave();
                    });
                });
                
                // Action buttons
                card.querySelector('.card-move-up').addEventListener('click', () => movePlayer(index, -1));
                card.querySelector('.card-move-down').addEventListener('click', () => movePlayer(index, 1));
                card.querySelector('.card-delete').addEventListener('click', () => removePlayer(index));
                
                container.appendChild(card);
            });
        }
        
        function drawField() {
            const canvas = document.getElementById('fieldCanvas');
            const ctx = canvas.getContext('2d');
            // Use display size for drawing calculations
            const size = parseInt(canvas.style.width) || canvas.width / (window.devicePixelRatio || 1);
            
            // Clear canvas
            ctx.clearRect(0, 0, size, size);
            
            // Save context for scaling
            ctx.save();
            
            // Draw grass with gradient
            const grassGradient = ctx.createRadialGradient(size/2, size/2, size/12, size/2, size/2, size*0.67);
            grassGradient.addColorStop(0, '#5cb85c');
            grassGradient.addColorStop(1, '#4CAF50');
            ctx.fillStyle = grassGradient;
            ctx.fillRect(0, 0, size, size);
            
            // Draw infield dirt
            ctx.fillStyle = '#8D6E63';
            ctx.beginPath();
            ctx.moveTo(size * 0.5, size * 0.75);
            ctx.lineTo(size * 0.75, size * 0.5);
            ctx.lineTo(size * 0.5, size * 0.25);
            ctx.lineTo(size * 0.25, size * 0.5);
            ctx.closePath();
            ctx.fill();
            
            // Draw pitcher's mound
            ctx.fillStyle = '#6D4C41';
            ctx.beginPath();
            ctx.arc(size * 0.5, size * 0.6, size * 0.05, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw bases
            ctx.fillStyle = 'white';
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            
            // Home plate
            ctx.beginPath();
            ctx.moveTo(size * 0.5, size * 0.742);
            ctx.lineTo(size * 0.475, size * 0.717);
            ctx.lineTo(size * 0.475, size * 0.692);
            ctx.lineTo(size * 0.5, size * 0.667);
            ctx.lineTo(size * 0.525, size * 0.692);
            ctx.lineTo(size * 0.525, size * 0.717);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // First base
            const baseSize = size * 0.033;
            ctx.fillRect(size * 0.683, size * 0.483, baseSize, baseSize);
            ctx.strokeRect(size * 0.683, size * 0.483, baseSize, baseSize);
            
            // Second base
            ctx.save();
            ctx.translate(size * 0.5, size * 0.367);
            ctx.rotate(Math.PI / 4);
            ctx.fillRect(-baseSize/2, -baseSize/2, baseSize, baseSize);
            ctx.strokeRect(-baseSize/2, -baseSize/2, baseSize, baseSize);
            ctx.restore();
            
            // Third base
            ctx.fillRect(size * 0.283, size * 0.483, baseSize, baseSize);
            ctx.strokeRect(size * 0.283, size * 0.483, baseSize, baseSize);
            
            // Draw foul lines
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(size * 0.5, size * 0.717);
            ctx.lineTo(size * 0.833, size * 0.383);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(size * 0.5, size * 0.717);
            ctx.lineTo(size * 0.167, size * 0.383);
            ctx.stroke();
            
            // Draw outfield fence
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(size * 0.5, size * 0.717, size * 0.633, -0.7 * Math.PI, -0.3 * Math.PI);
            ctx.stroke();
            
            
            ctx.restore();
        }
        
        function updateField() {
            drawField();
            
            const canvas = document.getElementById('fieldCanvas');
            const ctx = canvas.getContext('2d');
            // Use CSS display size for position calculations
            const size = parseInt(canvas.style.width) || 600;
            const inning = currentInning - 1;
            
            // Track occupied positions
            const occupiedPositions = {};
            
            playerData.forEach((player, battingOrder) => {
                const position = player.positions[inning];
                // Skip if position is empty, bench, or invalid
                if (position && position !== 'BN' && positionCoords[position]) {
                    if (!occupiedPositions[position]) {
                        occupiedPositions[position] = [];
                    }
                    occupiedPositions[position].push({
                        name: player.name,
                        order: battingOrder + 1
                    });
                }
            });
            
            // Draw players
            Object.entries(occupiedPositions).forEach(([position, players]) => {
                const baseCoord = positionCoords[position];
                
                players.forEach((player, index) => {
                    // Calculate position with offset for multiple players
                    const offsetX = (index * 0.042 - ((players.length - 1) * 0.042) / 2) * size;
                    const x = baseCoord.x * size + offsetX;
                    const y = baseCoord.y * size;
                    const playerRadius = size * 0.03;
                    
                    // Draw player circle with gradient
                    const gradient = ctx.createRadialGradient(x, y, 0, x, y, playerRadius);
                    gradient.addColorStop(0, '#FFD700');
                    gradient.addColorStop(1, '#FFA500');
                    ctx.fillStyle = gradient;
                    ctx.strokeStyle = '#1b3a6b';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, y, playerRadius, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw position label (larger on mobile)
                    const isMobile = window.innerWidth <= 768;
                    const positionFontSize = isMobile ? Math.floor(size * 0.028) : Math.floor(size * 0.022);
                    const nameFontSize = isMobile ? Math.floor(size * 0.032) : Math.floor(size * 0.024);
                    
                    ctx.fillStyle = '#1b3a6b';
                    ctx.font = `bold ${positionFontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(position, x, y);
                    
                    // Draw player name (first name only, larger font on mobile)
                    if (player.name) {
                        ctx.fillStyle = 'white';
                        ctx.strokeStyle = '#1b3a6b';
                        ctx.lineWidth = 4;
                        ctx.font = `bold ${nameFontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial`;
                        const nameParts = player.name.split(' ');
                        const firstName = nameParts[0];
                        const nameY = y + playerRadius + (size * 0.025);
                        ctx.strokeText(firstName, x, nameY);
                        ctx.fillText(firstName, x, nameY);
                    }
                });
            });
        }
    </script>
</body>
</html>